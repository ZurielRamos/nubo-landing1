<section class="after">
    <div class="phase">
        <div class="image-animation">
            <canvas id="after-canvas"></canvas>
            <div class="text-container">
                <div class="text-content">
                    <div class="title mb-4">
                        <h2 class="text-7xl text-center">Sentirte bien</h2>
                        <span class="text-3xl text-center"
                            >al final del día también importa</span
                        >
                    </div>
                    <p class="text-xl font-light text-center">
                        Después de una jornada larga, el cuerpo necesita
                        relajarse y liberar tensiones. El confort adecuado ayuda
                        a que ese momento de pausa sea realmente reparador. Nubo
                        te acompaña en ese espacio entre la rutina y el
                        descanso.
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    const canvas = document.getElementById("after-canvas") as HTMLCanvasElement;
    const context = canvas.getContext("2d");

    // Import frames for after component
    const frames = import.meta.glob("/src/assets/bg-after/*.webp", {
        eager: true,
    });

    // Sort keys to ensure correct order
    const frameKeys = Object.keys(frames).sort();
    const frameCount = frameKeys.length;

    const images: HTMLImageElement[] = [];
    const sequence = { frame: 0 };

    // Preload images
    frameKeys.forEach((key) => {
        const img = new Image();
        // @ts-ignore
        img.src = frames[key].default.src;
        images.push(img);
    });

    if (images.length > 0) {
        images[0].onload = render;

        gsap.to(sequence, {
            frame: frameCount, // Animate through all frames
            ease: "none",
            scrollTrigger: {
                trigger: ".after",
                start: "top bottom",
                end: "bottom top",
                scrub: 0.1,
            },
            onUpdate: render,
        });
    }

    function render() {
        if (!context || images.length === 0) return;

        // Safety check and conversion to integer index
        let index = Math.floor(sequence.frame);
        if (index < 0) index = 0;
        if (index >= images.length) index = images.length - 1;

        const img = images[index];
        if (!img) return;

        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        const imgWidth = img.width;
        const imgHeight = img.height;

        // Cover logic
        const ratio = Math.max(
            canvasWidth / imgWidth,
            canvasHeight / imgHeight,
        );
        const centerShift_x = (canvasWidth - imgWidth * ratio) / 2;
        const centerShift_y = (canvasHeight - imgHeight * ratio) / 2;

        context.clearRect(0, 0, canvasWidth, canvasHeight);
        context.drawImage(
            img,
            0,
            0,
            imgWidth,
            imgHeight,
            centerShift_x,
            centerShift_y,
            imgWidth * ratio,
            imgHeight * ratio,
        );
    }

    function resize() {
        if (!canvas) return;
        const parent = canvas.parentElement;
        if (parent) {
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;
            render();
        }
    }

    window.addEventListener("resize", resize);
    resize();
</script>

<style>
    .after {
        width: 100%;
        height: 95vh;
        display: flex;
        align-items: center;
        margin-top: 4rem;
        position: relative;
    }

    .phase {
        width: 100%;
        height: 95vh;
        gap: 4rem;
        display: flex;
        align-items: center;
    }

    .image-animation {
        width: 100%;
        height: 95vh;
        background-color: transparent; /* Removed debug red */
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    #after-canvas {
        width: 100%;
        height: 100%;
        display: block;
    }

    .text-container {
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: absolute;
        backdrop-filter: blur(10px);
        color: white;
    }

    .text-content {
        width: 50%;
        min-height: 50%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .title {
        display: flex;
        flex-direction: column;
        margin-bottom: 2rem;
    }

    .title h2 {
    }

    .title span {
        background-color: var(--primary);
        padding-left: 2rem;
        padding-right: 2rem;
    }
</style>
