---
import ButtonLink from "./ButtonLink.astro";
import Header from "./Header.astro";
---

<Header />
<section class="hero-container">
    <canvas id="hero-canvas"></canvas>

    <div class="hero-content">
        <div class="phase phase-1">
            <div class="title-card">
                <div class="title">
                    <h1>Bienestar</h1>
                    <span>que acompaña tu día</span>
                    <strong>de principio a fin.</strong>
                </div>
                <div>
                    <p>
                        Porque el bienestar no es solo dormir bien. Es cómo te
                        despiertas, cómo te sientas, cómo trabajas y cómo
                        descansas al final del día.
                    </p>
                </div>
                <a
                    href="#"
                    class="text-xl font-light text-white flex gap-4 items-center"
                    >Llamado a la acción 1
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 512 196.6"
                        width="32"
                    >
                        <g>
                            <path
                                d="M512,93.23v9.04c-1.87,1.13-2.15,4.25-4.42,5.83l-123.98,86.39c-1.88.28-2.89.93-3.61,2.11h-1.68c-4.48-3.06-9.76-4.59-9.68-13.86.04-4.74,2.32-8.99,6.3-11.45l86.11-60.68-447.82-.13c-6.45,0-9.63-2.63-13.24-7.91v-9.64c3.63-5.22,6.81-7.85,13.23-7.85l447.85-.13-87.92-62.02c-5.07-4.52-5.77-12.08-2.72-17.41,3.21-5.62,9.2-7.19,14.46-3.53l122.69,85.42c2.25,1.57,2.54,4.72,4.41,5.83Z"
                                fill="#fff"></path>
                        </g>
                    </svg>
                </a>
            </div>
        </div>
    </div>
</section>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    const canvas = document.getElementById("hero-canvas") as HTMLCanvasElement;
    const context = canvas.getContext("2d");

    // Import frames for hero
    const frames = import.meta.glob("/src/assets/bg-hero/*.jpg", {
        eager: true,
    });

    const frameKeys = Object.keys(frames).sort();
    const frameCount = frameKeys.length;

    const images: HTMLImageElement[] = [];
    const sequence = { frame: 0 };

    frameKeys.forEach((key) => {
        const img = new Image();
        // @ts-ignore
        img.src = frames[key].default.src;
        images.push(img);
    });

    if (images.length > 0) {
        images[0].onload = render;

        // Sequence animation
        gsap.to(sequence, {
            frame: frameCount,
            ease: "none",
            scrollTrigger: {
                trigger: ".hero-container",
                start: "top top",
                end: "bottom top",
                scrub: 0.1,
            },
            onUpdate: render,
        });

        // Parallax effect for canvas
        gsap.to("#hero-canvas", {
            yPercent: 50,
            ease: "none",
            scrollTrigger: {
                trigger: ".hero-container",
                start: "top top",
                end: "bottom top",
                scrub: 0.1,
            },
        });

        // Parallax lag for title-card
        gsap.to(".title-card", {
            y: 200, // Move down to resist scroll (slower movement)
            opacity: 0, // Fade out as it disappears
            ease: "none",
            scrollTrigger: {
                trigger: ".hero-container",
                start: "top top",
                end: "60% top", // Finish effect a bit before the very end
                scrub: 0.1,
            },
        });
    }

    function render() {
        if (!context || images.length === 0) return;

        let index = Math.floor(sequence.frame);
        if (index < 0) index = 0;
        if (index >= images.length) index = images.length - 1;

        const img = images[index];
        if (!img) return;

        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        const imgWidth = img.width;
        const imgHeight = img.height;

        const ratio = Math.max(
            canvasWidth / imgWidth,
            canvasHeight / imgHeight,
        );
        const centerShift_x = (canvasWidth - imgWidth * ratio) / 2;
        const centerShift_y = (canvasHeight - imgHeight * ratio) / 2;

        context.clearRect(0, 0, canvasWidth, canvasHeight);
        context.drawImage(
            img,
            0,
            0,
            imgWidth,
            imgHeight,
            centerShift_x,
            centerShift_y,
            imgWidth * ratio,
            imgHeight * ratio,
        );
    }

    function resize() {
        if (!canvas) return;
        const parent = canvas.parentElement;
        if (parent) {
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;
            render();
        }
    }

    window.addEventListener("resize", resize);
    resize();
</script>

<style>
    .title {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .title h1 {
        font-size: 6rem;
        line-height: 1;
        font-weight: 500;
        color: white;
    }
    .title span {
        font-size: 3rem;
        font-weight: 100;
        line-height: 1;
        color: white;
    }
    .title strong {
        line-height: 1;
        font-size: 4rem;
        font-weight: 500;
        color: white;
        position: relative;
        z-index: 2;
    }

    .title strong::before {
        content: "";
        display: block;
        width: 100%;
        height: 40px;
        background-color: var(--primary);
        position: absolute;
        bottom: 0;
        left: -20px;
        z-index: -1;
    }

    .title-card p {
        font-size: 1.3rem;
        margin-top: 2rem;
        font-weight: 200;
        color: white;
    }

    .title-card a {
        margin-top: 2rem;
        color: white;
    }

    .hero-container {
        width: 100%;
        min-height: 100vh;
        position: relative;
        overflow: hidden;
    }

    #hero-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0; /* Behind content */
    }

    .hero-content {
        position: relative;
        z-index: 10;
        width: 100%;
        height: 100%;
    }

    .phase {
        width: 100%;
        height: 100vh;
        display: flex;
        align-items: center;
    }

    .title-card {
        transform: translateY(-0vh) translateX(5vw);
        width: 50%;
        min-height: 50%;
        display: flex;
        justify-content: center;
        flex-direction: column;
        border-radius: 1rem;
        padding: 4rem;
    }
</style>
