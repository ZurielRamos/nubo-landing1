---
interface ImageNode {
    sourceUrl: string;
}

interface Product {
    name: string;
    price: string;
    slug: string;
    image?: ImageNode;
    galleryImages?: {
        nodes: ImageNode[];
    };
}

interface Props {
    product: Product;
}

const { product } = Astro.props;

// Combine and limit images
let images = [];
if (product.image?.sourceUrl) images.push(product.image.sourceUrl);
if (product.galleryImages?.nodes) {
    product.galleryImages.nodes.forEach((img: any) => {
        if (img.sourceUrl) images.push(img.sourceUrl);
    });
}
images = images.slice(0, 3);
---

<a
    href={`https://nubolab.strategee.us/producto/${product.slug}`}
    class="product-card"
>
    <div class="image-container" data-image-count={images.length}>
        {
            images.length > 0 ? (
                images.map((imgSrc, index) => (
                    <img
                        src={imgSrc}
                        alt={`${product.name} - View ${index + 1}`}
                        loading="lazy"
                        class={`product-image ${index === 0 ? "active" : ""}`}
                    />
                ))
            ) : (
                <div class="placeholder-image">
                    <span>No Image</span>
                </div>
            )
        }
        {
            images.length > 1 && (
                <div class="hover-indicators">
                    {images.map((_, idx) => (
                        <span
                            class={`indicator ${idx === 0 ? "active" : ""}`}
                        />
                    ))}
                </div>
            )
        }
    </div>
    <div class="info">
        <h3>{product.name}</h3>
        <!-- <div class="price" set:html={product.price} /> -->
    </div>
</a>

<script>
    // Initializing logic for all product cards handles by selector
    // We use a function to init distinct containers to avoid re-binding if we used global selectors blindly
    // But since this script runs once, we can just query all .image-container (that don't have listeners yet if we were dynamic, but here page load is fine)

    // Better: use scoped logic if possible, but for Astro it's module based.
    // We can just iterate all .image-container that are present.

    function initProductCards() {
        const containers = document.querySelectorAll(".image-container");

        containers.forEach((container) => {
            // Avoid double Init if we had some marker, but not strictly necessary for simple page load
            const images = container.querySelectorAll(".product-image");
            const indicators = container.querySelectorAll(".indicator");
            const imageCount = images.length;

            if (imageCount < 2) return;

            container.addEventListener("mousemove", (e) => {
                const rect = (container as HTMLElement).getBoundingClientRect();
                const x = (e as MouseEvent).clientX - rect.left;
                const width = rect.width;

                const segmentSize = width / imageCount;
                let index = Math.floor(x / segmentSize);

                if (index < 0) index = 0;
                if (index >= imageCount) index = imageCount - 1;

                images.forEach((img, i) => {
                    img.classList.remove("active", "prev", "next");
                    if (i < index) img.classList.add("prev");
                    else if (i === index) img.classList.add("active");
                    else img.classList.add("next");
                });

                if (indicators.length) {
                    indicators.forEach((ind) => ind.classList.remove("active"));
                    indicators[index].classList.add("active");
                }
            });

            container.addEventListener("mouseleave", () => {
                images.forEach((img, i) => {
                    img.classList.remove("active", "prev", "next");
                    if (i === 0) img.classList.add("active");
                });
                if (indicators.length) {
                    indicators.forEach((ind) => ind.classList.remove("active"));
                    indicators[0].classList.add("active");
                }
            });
        });
    }

    // Run on load
    initProductCards();

    // If using View Transitions in Astro 3/4, might need to listen to astro:page-load
    document.addEventListener("astro:page-load", initProductCards);
</script>

<style>
    .product-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow:
            0 4px 6px -1px rgba(0, 0, 0, 0.1),
            0 2px 4px -1px rgba(0, 0, 0, 0.06);
        height: 100%;
        width: 100%;
        transition:
            transform 0.3s ease,
            box-shadow 0.3s ease;
        display: flex;
        flex-direction: column;
        text-decoration: none; /* Reset anchor style */
        color: inherit; /* Reset anchor style */
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow:
            0 10px 15px -3px rgba(0, 0, 0, 0.1),
            0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .image-container {
        position: relative;
        padding-top: 100%; /* 1:1 aspect ratio */
        background-color: #f3f4f6;
        overflow: hidden;
    }

    .image-container img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: translateX(100%);
        transition: transform 0.3s ease-out;
        z-index: 10;
        will-change: transform;
    }

    .image-container img.active {
        transform: translateX(0);
        z-index: 20;
    }

    .image-container img.prev {
        transform: translateX(-100%);
        z-index: 10;
    }

    .hover-indicators {
        position: absolute;
        bottom: 10px;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 5px;
        z-index: 30;
        pointer-events: none;
    }

    .indicator {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.5);
        transition:
            background-color 0.2s ease,
            transform 0.2s ease;
    }

    .indicator.active {
        background-color: white;
        transform: scale(1.2);
    }

    .placeholder-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        background-color: #e5e7eb;
    }

    .info {
        padding: 1.5rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .info h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
        color: #1f2937;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .price {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary);
    }
</style>
